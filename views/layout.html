<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% block title %}My Site{% endblock %}</title>

  {% block head %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="http://fonts.googleapis.com/css?family=PT+Sans:400,700" rel="stylesheet" type="text/css">
	<link href="css/persona-buttons.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]>
	<script src="js/html5shiv.js"></script>
	<![endif]-->
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://login.persona.org/include.js"></script>
  <script>

	  navigator.id.watch({

        // this is the callback that persona triggers when the user logs in
        onlogin: function(assertion) {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/auth/status", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.addEventListener("loadend", function(e) {
            var data = JSON.parse(this.responseText);
            if (data && data.status === "okay") {
			  document.querySelector("#login").style.display = "none";
			  document.querySelector("#invitations").style.display = "block";
	/*
              document.querySelector("#user").textContent = data.email;
              document.querySelector("#login").disabled = "disabled";
              document.querySelector("#guest").disabled = "disabled";
              document.querySelector("#logout").disabled = "";
*/
            }
          }, false);
          xhr.send(JSON.stringify({
            assertion: assertion
          }));
        },

        // this is the callback that persona triggers when the user logs out
        onlogout: function() {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", "/auth/logout", true);
          xhr.addEventListener("loadend", function(e) {
			alert('logout');
			window.location = "http://www.openpath.me";
	/*
            document.querySelector("#user").textContent = "logged out";
            document.querySelector("#login").disabled = "";
            document.querySelector("#guest").disabled = "";
            document.querySelector("#logout").disabled = "disabled";
*/
          }, false);
          xhr.send();
        }
		//
      });
      
      // actions that happen when one of the three buttons is clicked
      document.addEventListener("DOMContentLoaded", function() {

        document.querySelector("#login").addEventListener("click", function() {
          navigator.id.request();
        }, false);

        document.querySelector("#logout").addEventListener("click", function() {
          navigator.id.logout();
        }, false);

        document.querySelector("#guest").addEventListener("click", function() {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", "/auth/guest", true);
          xhr.addEventListener("loadend", function(e) {
            var data = JSON.parse(this.responseText);
            if (data && data.status === "okay") {
              document.querySelector("#user").textContent = data.email;
              document.querySelector("#login").disabled = "disabled";
              document.querySelector("#guest").disabled = "disabled";
              document.querySelector("#logout").disabled = "";
            }
          }, false);
          xhr.send();
        }, false);

        // call auth/status when page first loads to see if user is logged in already
        var xhr = new XMLHttpRequest();
          xhr.open("POST", "/auth/status", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.addEventListener("loadend", function(e) {
            var data = JSON.parse(this.responseText);
            if (data && data.status === "okay") {
              document.querySelector("#user").textContent = data.email;
              document.querySelector("#login").disabled = "disabled";
              document.querySelector("#guest").disabled = "disabled";
              document.querySelector("#logout").disabled = "";
            }
          }, false);
          xhr.send(JSON.stringify({
            //assertion: assertion
          }));

      }, false);

  </script>

  {% endblock %}
</head>
<body>
  {% block content %}
  <h1>Hello, openPath</h1>
  <p>Current user is: <span id="user">logged out</span></p>
  <button id="login">Login with Persona</button>
  <button id="guest">Enter as Guest</button>
  <button id="logout" disabled="disabled">Logout</button>
  {% endblock %}
</body>
</html>