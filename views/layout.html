<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% block title %}Open Path{% endblock %}</title>

  {% block head %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="http://fonts.googleapis.com/css?family=PT+Sans:400,700" rel="stylesheet" type="text/css">
	<link href="css/persona-buttons.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]>
	<script src="js/html5shiv.js"></script>
	<![endif]-->
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://login.persona.org/include.js"></script>
  <script>
	  var username = "";
	  var showUsername = function(user){
		 if(user != "guest"){
			// pull username from front of email address and display in interface
			username = user.match(/^([^@]*)@/)[1];

			//document.querySelector("#users").innerHTML += '<div class="user"><div class="usermeta"><div class="username"><span id="username1">'+username+'</span><div class="foundicon-location"><span>X</span></div></div><div class="userlocation">University Place, NY</div><div id="usermap1" class="usermap"></div></div><video id="self_videoplayer" class="avatar" width="240" height="auto" poster="img/poster.png" autoplay></video></div>';
			
		}else{
			username = user;
		}
		document.querySelector("#username1").textContent = username;
	  }
	  navigator.id.watch({
        // this is the callback that persona triggers when the user logs in
        onlogin: function(assertion) {
		   console.log('onlogin');
		
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/auth/status", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.addEventListener("loadend", function(e) {
          var data = JSON.parse(this.responseText);
			
			console.log('onlogin data.status: ' + data.status);
            
			if (data && data.status === "okay") {
	
			  var path = window.location.pathname;
			  console.log('onlogin path: ' + path);
			  if(path == '/'){
				// ON LOGIN: do homepage handling
				console.log('ON LOGIN: do homepage handling');
				document.querySelector("#login").style.display = "none";
				document.querySelector("#invitations").style.display = "block";
			  }else if(path == '/main'){
				// ON LOGIN: do main handling
				console.log('ON LOGIN: do main handling');
				
				showUsername(data.email);
				
				
			  }
            }
          }, false);
          xhr.send(JSON.stringify({
            assertion: assertion
          }));
        },

        // this is the callback that persona triggers when the user logs out
        onlogout: function() {
		  console.log('onlogout');
          var xhr = new XMLHttpRequest();
          xhr.open("GET", "/auth/logout", true);
          xhr.addEventListener("loadend", function(e) {

		  var path = window.location.pathname;
		  console.log('onlogout path: ' + path);
		  if(path == '/'){
			console.log('stage 1');
			// user is at invite stage
			document.querySelector("#login").style.display = "block";
			document.querySelector("#invitations").style.display = "none";
		  }else if(path == '/main'){
			console.log('stage 2');
			// redirect to home 
			window.location = "/";
		  }
          }, false);
          xhr.send();
        }
      });

  // actions that happen when page has loaded
  document.addEventListener("DOMContentLoaded", function() {
	
    // call auth/status when page first loads to see if user is logged in already
    var xhr = new XMLHttpRequest();
      xhr.open("POST", "/auth/status", true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.addEventListener("loadend", function(e) {
        var data = JSON.parse(this.responseText);
		
        if (data && data.status === "okay") {
		  showUsername(data.email);
		  var path = window.location.pathname;
		  console.log('DOMContentLoaded path: ' + path);
		  if(path == '/'){
			console.log('ON PAGE: do homepage stuff');
		  }else if(path == '/main'){
			console.log('ON PAGE: do main stuff');
		  }
        }
      }, false);
      xhr.send(JSON.stringify({
        //assertion: assertion
      }));

  }, false);
  </script>

  {% endblock %}
</head>
<body>
  {% block content %}

  {% endblock %}
</body>
</html>