{% extends 'layout.html' %}

{% block title %}OpenPath{% endblock %}

{% block head %}
    {% parent %}
	<link rel="stylesheet" href="css/style.css" />
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>
	<script src="js/webrtc.io.js"></script>
	<script>
		// Bootstrap interface calls through JQuery
        $(document).ready(function() {
	/*
			// determines tab to display based on hash
			var url = document.location.toString();
			if (url.match('#')) {
			    $('#mainnav a[href=#'+url.split('#')[1]+']').tab('show') ;
			} 

			// Change hash for page-reload
			$('#mainnav a').on('shown', function (e) {
			    window.location.hash = e.target.hash;
			})
	*/
			// Main Navigation Tabs
			$('#mainnav a').click(function (e) {
			  e.preventDefault();
			  $(this).tab('show');
			})
            $("#mainnav a").tooltip({placement:'bottom'});

			$('#usernav a').click(function (e) {
			  e.preventDefault();
			  $(this).tab('show');
			})
			$('#logout').mouseup(function() {
				navigator.id.logout('button pressed');
			});
			// User Icon - Right Column Main Screen
			$('.user').mouseenter(function(event) {
				$(this).find(".usermeta").fadeIn("slow");
				$(this).find(".username").fadeIn("slow");
        	});
			$('.user').mouseleave(function(event) {
				var isShowing = $(this).find(".usermeta").hasClass("usermetashowing");
				if(!isShowing){
					$(this).find(".usermeta").fadeOut("slow");
					$(this).find(".username").fadeOut("slow");
				}
        	});		
			$('.icon-map-marker').click(function(event) {
				$(this).parent().parent().addClass('usermetashowing');
				$(this).parent().parent().find('.usermap').fadeIn("slow");
				$(this).parent().parent().find('.userlocation').fadeIn("slow");

				$(this).addClass('closebtn');	
				event.stopPropagation();
        	});
			$('.icon-remove').click(function(event) {
				console.log("icon-remove clicked");
				$(this).parent().parent().parent().removeClass('usermetashowing');
				$(this).parent().parent().fadeOut("slow");
				$(this).parent().parent().parent().find('.usermap').fadeOut("slow");
				$(this).parent().parent().parent().find('.userlocation').fadeOut("slow");
				$(this).parent().removeClass('closebtn');
				event.stopPropagation();
			});
			$('.avatar').dblclick(function(event) {
				console.log('dblclick');
				var tmp = $(this).attr('src');
				if($('#main_videoplayer').attr('src') == undefined){
					$('#main_videoplayer').attr('src', tmp);
				}else{
					$('#main_videoplayer').attr('src', '');
				}
        	});
			// Validates and submits email inviting participant
			$('#adduserform').submit(function() {
				var email = $('#to').val();
				var isValid = validateEmail(email);
				
				if(!isValid){
					$('#emailerror').modal();
				}else{
					var data = $('#adduserform').serialize(); // serialize all the data in the form 
					$.ajax({
						url: '/email',
					    data: data,
					    dataType:'json',
					    type:'POST',
					    async:false,
						success: function(data) {        
					      for (key in data.email) {
					        alert(data.email[key]);
					      }
					    },
					    error: function(data){}
					});
				};
				return false;
        	});
       
	  /*********************************************/
	  // Video and Map code
	  /*********************************************/

      var firstname, lastname, latitude, longitude, watchID;
      var username;
	  var map1;
	  var eventsMap;
	  var geocoder;

      var room = 1;
	  var max_num_videos = 2;
      var server = "ws://www.walking-productions.com:8001/";  
      var main_video = null;
	  var other_video = null;
	  var videos = [];
      var PeerConnection = window.PeerConnection || window.webkitPeerConnection00 || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
	  console.log(PeerConnection);    
      
	  window.addEventListener('load', initUser, false);
	  /**
	  * Starts video, chat, and geolocation
	  */
	  function initUser() {    
		console.log('initUser');

		if (PeerConnection) {
			rtc.createStream({"video": true, "audio": true}, function(stream) {
				document.getElementById('self_videoplayer').src = URL.createObjectURL(stream);
				rtc.attachStream(stream, 'self_videoplayer');
			});
		} else {
			alert('Sorry, your browser is not supported');
		}

		console.log("server: " + server);
		console.log("room: " + room);

		rtc.connect(server, room);

		rtc.on('add remote stream', function(stream, socketId) {
			console.log("Remote stream: " + stream + " " + socketId);

			if (videos.length < max_num_videos) {
				var newVideo = new initVideo(stream, socketId);
			}
		});

		rtc.on('disconnect stream', function(socketId) {
			console.log('disconnect stream ' + socketId);

			var domId = null;
			for (var i = 0; i < videos.length; i++) {
				if (videos[i].socketId == socketId) {
					if (videos[i] == main_video) { 
						main_video = null; 
						document.getElementById('main_videoplayer').src = "";
						console.log("main_video");
					}else if (videos[i] == other_video) { 
						other_video = null; 
						document.getElementById('other_videoplayer').src = "";
						console.log("other_video");
					}
					videos.splice(videos[i]);

					console.log("removed video");
					break;
				}	
			}
		});

		rtc.on('main_video_socketid', function(data) {
			console.log(data.socketid);
		});

		// initialize remainder of interface
		initUserMap();
		initEventsMap();
		initEventsList('/events');
        initChat();

        window.removeEventListener('load', initUser, false);
      } 
	  /**
	  *
	  */
	  function initVideo(stream, socketId) {
		this.stream = stream;
		this.socketId = socketId;
		this.domId = null;

		if (main_video == null) {
       	  	rtc.attachStream(stream, 'main_videoplayer');
			main_video = this;
			this.domId = 'main_videoplayer';
			videos.push(this);
			console.log("Adding video as main_videoplayer");
		} else if (other_video == null) {
			rtc.attachStream(stream, 'other_videoplayer');
			other_video = this;	
			this.domId = 'other_videoplayer';
			videos.push(this);
			console.log("Adding video as other_videoplayer");
		} else {
			console.log("No room for more videos");
		}
	  }
	  /**
	  * Retreives geolocation for display within map.
	  */
	  function initUserMap() {
		  // Try HTML5 geolocation
		  if(navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position) {
		     	var pos = new google.maps.LatLng(position.coords.latitude,  position.coords.longitude);

				var mapOptions = {
					zoom: 6,
					center: pos,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					mapTypeControl: true,
					mapTypeControlOptions: {
						style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
						position: google.maps.ControlPosition.RIGHT_BOTTOM
					},
				};
				map1 = new google.maps.Map(document.getElementById('usermap1'), mapOptions);

			  var marker = new google.maps.Marker({
			      position: pos,
			      map: map1,
			      title: ''
			  });
			
			  // get and display street address 
			  codeLatLng(pos, "#userlocation1");
			
		    }, function() {
		      handleNoGeolocation(true);
		    });
		  } else {
		    // Browser doesn't support Geolocation
		    handleNoGeolocation(false);
		  }
		
		
		
		
		/*
		  var mapOptions = {
			   zoom: 6,
			   center
			   mapTypeId: google.maps.MapTypeId.ROADMAP,
				mapTypeControl: true,
			    mapTypeControlOptions: {
			        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
			        position: google.maps.ControlPosition.RIGHT_BOTTOM
			    },
		  };
		  map1 = new google.maps.Map(document.getElementById('usermap1'), mapOptions);

		  // Try HTML5 geolocation
		  if(navigator.geolocation) {
		    navigator.geolocation.getCurrentPosition(function(position) {
		      var pos = new google.maps.LatLng(position.coords.latitude,  position.coords.longitude);

			  var marker = new google.maps.Marker({
			      position: pos,
			      map: map1,
			      title: ''
			  });
		      map1.setCenter(pos);
			  codeLatLng(pos, "#userlocation1");
		    }, function() {
		      handleNoGeolocation(true);
		    });
		  } else {
		    // Browser doesn't support Geolocation
		    handleNoGeolocation(false);
		  }
		*/
		};  
		/**
		* Handles geolocation error.
		*/
		function handleNoGeolocation(errorFlag) {
		  if (errorFlag) {
		    var content = 'Error: The Geolocation service failed.';
		  } else {
		    var content = 'Error: Your browser doesn\'t support geolocation.';
		  }

		  var options = {
		    map: map1,
			center: new google.maps.LatLng(40.7142, 74.0064),
		    position: new google.maps.LatLng(40.7142, 74.0064),
		    content: content
		  };
		  //map1.setCenter(options.position);
		}
   	  /**
	  * Initializes Map displaying local events
	  */
      function initEventsMap(){
		var options = {
		    map: eventsMap,
			zoom: 6,
			mapTypeId: google.maps.MapTypeId.ROADMAP,
			mapTypeControl: true,
			mapTypeControlOptions: {
			        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
			        position: google.maps.ControlPosition.RIGHT_BOTTOM
			},
		    center: new google.maps.LatLng(60, 105),
		    position: new google.maps.LatLng(60, 105)
		  };
		  eventsMap = new google.maps.Map(document.getElementById('eventsmap'), options);	
		  eventsMap.setCenter(options.position);
	  }
	  /**
	  * Returns reverse-geocoded location
	  * @param pos		Lat/Long object
	  * @param target	target HTML element to write to
	  */
	  function codeLatLng(pos, target) {
		  geocoder = new google.maps.Geocoder();
		  geocoder.geocode({'latLng': pos}, function(results, status) {
		    if (status == google.maps.GeocoderStatus.OK) {
		      if (results[1]) {
				$(target).html(results[1].formatted_address);
		      } else {
		        console.log('No results found');
		      }
		    } else {
		      console.log('Geocoder failed due to: ' + status);
		    }
		  });
		}
  	  /**
	  * Adds user to chat window.
	  */
      function addToChat(user, msg) {
        var chatwindow = document.getElementById('chatwindow');
        var chatmessages = document.getElementById('chatmessages');
        msg = sanitize(msg);
        msg = '<li class="user1"><span>'+ user +'</span>: ' + msg + '</li>';
        chatmessages.innerHTML += msg;
        chatwindow.scrollTop = chatwindow.scrollHeight;
      }
  	  /**
	  * Sanitizes user message in chat window.
	  */
      function sanitize(msg) {
        return msg.replace(/</g, '&lt;');
      }
  	  /**
	  * Creates chat window.
	  */
      function initChat() {
        var input = document.getElementById("chatinput");

        input.addEventListener('keydown', function(event) {
            if(input.value != ''){
                var key = event.which || event.keyCode;
                //console.log(key);
                if (key === 13) {
		var message = username + ": " + input.value;	
                    //console.log(rtc);
                    rtc._socket.send(JSON.stringify({
                        "eventName": "chat_msg",
                        "data": {
                        "messages": message,
                        "room": room
                    }
                    }));
                    addToChat(username, input.value);
                    input.value = "";
                }
            }
          
        }, false);
        rtc.on('receive_chat_msg', function(data) {
          console.log(data.color);
          addToChat(data.messages);
        });
        
        rtc.on('main_video_socketid', function(data) {
        	console.log(data.socketid);
        	
        });
      }
		/**
		* Parses and displays events
		* @param array of json objects
		*/
		function initEventsList(list){
			var output = "";
			var evt;
			for(var i in list){
				evt = list[i];
				output += '<article>';
				output += '<a href="'+ evt.link +'" target="_blank"><h3>' + evt.name + '</h3></a>';
				output += evt.startTime + ' to ' + evt.endTime + '<br>';
				output += evt.locationDescription + '<br>';
				output += '<p>' + evt.description + '</p>';
				output += '</article>';
			}
			console.log(output);
			//$('#eventsholder').html(output);
		}	
	  /**
	  * Display username in interface
	 
	  function showUsername(user){
		console.log('show user: ' + user);
		 if(user != "guest"){
			// pull username from front of email address and display in interface
			// will allow user to change in future version; will store in user data along w prefs
			username = user.match(/^([^@]*)@/)[1];		
		}else{
			username = user;
		};
		$("#username1").html(username);
		$("#profileUsername").html(username);	
	  };
	 */
		});
    </script>
{% endblock %}

{% block content %}
<header id="mainheader">
    <div id="openpath">
		<a href="#main" data-toggle="tab"><img id="logo" src="img/openpath.png" alt="OpenPath"></a>
	</div>
    <nav id="mainnav">
        <ul>
			<li><a id="adduser-icon" href="#adduser" data-toggle="tab tooltip" title="Add Participants"></a></li>
			<li><a id="map-icon" href="#events" data-toggle="tab tooltip" title="Events"></a></li>
			<li><a id="profile-icon" href="#user" data-toggle="tab tooltip" title="Profile"><span class="badge badge-important">6</span></a></li>
        </ul>
    </nav>
    <div class="clearer"></div>
</header>
<div id="content">


	<div class="tab-content">
		
  	  <!-- ***** MAIN ***** -->
	  <div class="tab-pane active" id="main">
	  	<div class="col1">
	  		<!-- VIDEO -->
			<div id="video"><video id="main_videoplayer" width="100%" height="auto" poster="img/poster.png" autoplay controls>
	        	Your browser does not support the video tag.
			</video>
			</div>
	  	</div>
	  	<div class="col2">
			<!-- BEGIN USERS -->
            	<div id="users">
				<div class="user">
	            	<div class="usermeta">
						<div class="username"><a href="#" id="username1"></a><div class="icon-map-marker"><span class="icon-remove"></span></div></div>
						<div id="userlocation1" class="userlocation"></div>
						<div id="usermap1" class="usermap"></div>
	                </div>
	                <video id="self_videoplayer" class="avatar" width="240" height="auto" poster="img/poster.png" muted autoplay></video>
	            </div>
				<div class="user">
	            	<div class="usermeta">
						<div class="username"><a href="#" id="username2"></a><div class="icon-map-marker"><span class="icon-remove"></span></div></div>
						<div id="userlocation2" class="userlocation"></div>
						<div id="usermap2" class="usermap"></div>
	                </div>
	                <video id="other_videoplayer" class="avatar" poster="img/poster.png" autoplay></video>
	            </div>
				<div class="user">
	            	<div class="usermeta">
						<div class="username"><a href="#" id="username3"></a><div class="icon-map-marker"><span class="icon-remove"></span></div></div>
						<div id="userlocation3" class="userlocation"></div>
						<div id="usermap3" class="usermap"></div>
	                </div>
	                <video id="other_videoplayer2" class="avatar" poster="img/poster.png" autoplay></video>
	            </div>
				<div class="user">
	            	<div class="usermeta">
						<div class="username"><a href="#" id="username4"></a><div class="icon-map-marker"><span class="icon-remove"></span></div></div>
						<div id="userlocation4" class="userlocation"></div>
						<div id="usermap4" class="usermap"></div>
	                </div>
	                <video id="other_videoplayer3" class="avatar" poster="img/poster.png" autoplay></video>
	            </div>
	            </div>

				<!-- BEGIN CHAT -->
	            <div id="chat">
	            	<div id="chatwindow">
	                	<ol id="chatmessages"></ol>
	       	  	  </div>
				  <input type="text" id="chatinput" class="commentfield" />
	            </div>
				<!-- END CHAT -->  		
	
	  	</div>
	  	<div class="clearer"></div>
	  </div>
	
	  <!-- ***** ADD USER ***** -->
	  <div class="tab-pane" id="adduser">
			<form id="adduserform">
			  <fieldset>
			    <h1>Add Participants</h1>
			    <label>Email Address</label>
			    <input type="text" name="to" id="to" placeholder="">
			    <label>Subject</label>
			    <input type="text" name="subject" id="subject" value="Open Path Invitation" placeholder="">
				<textarea rows="10" name="text" id="text">
Hi,

<span class="username"></span> would like to invite you to a video session on Open Path. Click here to join:

Let's learn together!

Regards,
Open Path Team
				</textarea>

			    <button id="adduser-submit" type="submit" class="btn btn-primary">Send</button>
			  </fieldset>
			</form>
	  </div>
	
	  <!-- ***** EVENTS ***** -->
	  <div class="tab-pane" id="events">
		<div class="col1">
			<!-- BEGIN EVENTS MENU -->
            <div id="eventsmenu">
                <div class="col50 left">
                    <nav class="subnav">
                        <ul>
                            <li><a href="#">Nearby</a></li>
                            <li><a href="#">Upcoming</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="col50 right">
					<form class="form-search">
					    <div class="input-prepend">
					      <span class="add-on"><i class="icon-search"></i></span>
					      <input class="span2" id="inputIcon" type="text" placeholder="Search">
						</div>
					</form>
                </div>
                <div class="clearer"></div>
            </div>
			
			<!-- MAP -->
			<div id="eventsmap"></div>
		</div>
		<div class="col2">
			<!-- BEGIN EVENTS LIST -->
            <div class="eventslist" class="inner">
            <h2>List of Events</h2> <a href="#" class="btn btn-primary"><span class="icon-plus"></span> Add</a>
				<div class="eventsholder">
					
	            	<article>
		                <h3>Field trip to Science Museum</h3>
		                May 25th, 2013 3-4pm<br>
		                Fort Greene Park Science Museum<br>
		                This is the description of the event. You are going to learn so much. Led by Joe Smith, science docent at the museum.
		            </article>
		            <article>
		                <h3>Bird Watching Tour</h3>
		                May 26th, 2013 1-2pm<br>
		                Prospect Park<br>
		                Summer is back and so are the birds in Prospect Park.We will bring you to understand what’s a typical day for the birds in our neighbourhood.    
		            </article>
		            <article>
		                <h3>Field trip to Science Museum</h3>
		                May 25th, 2013 3-4pm<br>
		                Fort Greene Park Science Museum<br>
		                This is the description of the event. You are going to learn so much. Led by Joe Smith, science docent at the museum.
		            </article>
		            <article>
		                <h3>Bird Watching Tour</h3>
		                May 26th, 2013 1-2pm<br>
		                Prospect Park<br>
		                Summer is back and so are the birds in Prospect Park.We will bring you to understand what’s a typical day for the birds in our neighbourhood.    
		            </article>
	
				</div>
            </div>
			<!-- END EVENTS LIST -->
		</div>
		<div class="clearer"></div>
	  	
	  </div>
	
	  <!-- ***** USER ***** -->
	  <div class="tab-pane" id="user">
	  		<!-- BEGIN USER MENU -->
            <div id="usermenu">
                <div class="col50 left">
                    <img src="img/user-icon.png" alt="User"><h1 id="profileUsername"></h1>
                </div>
                <div class="col50 right">
                    <nav id="usernav" class="subnav">
                        <ul>
							<li class="active"><a data-toggle="tab" href="#profile">Profile</a></li>
                            <li><a data-toggle="tab" href="#mypath">My Path</a></li>
                            <li><a data-toggle="tab" href="#notifications">Notifications</a></li>
                            <li><a data-toggle="tab" href="#settings">Settings</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="clearer"></div>
            </div>
			<!-- END USER MENU -->
			<!-- BEGIN USER TAB-CONTENT -->
			<div class="tab-content">
				<div class="tab-pane active" id="profile">
					<div class="usertab-single-col">
					<p><strong>Welcome to Open Path!<br>To get recommendations based on your interests, simply fill in something about yourself:</strong></p>
					<form>
					  <fieldset>
					    <label>Grade Level:</label>
							<label class="radio inline"><input type="radio" name="gradelevel" value="Pre-K to Grade 2">Pre-K to Grade 2</label>
							<label class="radio inline"><input type="radio" name="gradelevel" value="Grade 3-5">Grade 3-5</label>
							<label class="radio inline"><input type="radio" name="gradelevel" value="Grade 9-12">Grade 9-12</label>
							<label class="radio inline"><input type="radio" name="gradelevel" value="Post Secondary">Post Secondary</label>
							<label class="radio inline"><input type="radio" name="gradelevel" value="Adults">Adults</label>
							<label class="radio inline"><input type="radio" name="gradelevel" value="Families">Families</label>
						<label>Interests:</label>
					    <input type="text" id="interests" name="interests">
					
						<label>List of Co-Learners:</label>
					    <input type="text" id="colearners" name="colearners">
						<p><small><em>*Required</em></small></p>
					    <button type="submit" class="btn btn-primary">Done</button>
					  </fieldset>
					</form>
					<a id="logout" class="btn" href="#">Logout</a>
					</div>
				</div>
				
				<div class="tab-pane" id="mypath">
					<div class="col1">
						<div id="mypath-map-canvas"></div>
					</div>
					<div class="col2">
						<!-- BEGIN EVENTS LIST -->
			            <div class="eventslist" class="inner">
			            <h2>List of Events</h2> <a href="#" class="btn btn-primary"><span class="icon-plus"></span> Add</a>
							<div class="eventsholder">
								
				            	<article>
					                <h3>Field trip to Science Museum</h3>
					                May 25th, 2013 3-4pm<br>
					                Fort Greene Park Science Museum<br>
					                This is the description of the event. You are going to learn so much. Led by Joe Smith, science docent at the museum.
					            </article>
					            <article>
					                <h3>Bird Watching Tour</h3>
					                May 26th, 2013 1-2pm<br>
					                Prospect Park<br>
					                Summer is back and so are the birds in Prospect Park.We will bring you to understand what’s a typical day for the birds in our neighbourhood.    
					            </article>
					            <article>
					                <h3>Field trip to Science Museum</h3>
					                May 25th, 2013 3-4pm<br>
					                Fort Greene Park Science Museum<br>
					                This is the description of the event. You are going to learn so much. Led by Joe Smith, science docent at the museum.
					            </article>
					            <article>
					                <h3>Bird Watching Tour</h3>
					                May 26th, 2013 1-2pm<br>
					                Prospect Park<br>
					                Summer is back and so are the birds in Prospect Park.We will bring you to understand what’s a typical day for the birds in our neighbourhood.    
					            </article>
					
							</div>
			            </div>
						<!-- END EVENTS LIST -->
					</div>
					<div class="clearer"></div>
					
				</div>
				
				<div class="tab-pane" id="notifications">
					<div class="usertab-single-col">
					<form>
					  <fieldset>
						<ul>
							<li><b>New event on NY Central Park about bird watching <span class="text-right">2 mins ago</span></b></li>
							<li><b>Your event - "New York Museum Tour" is starting in 1 hour <span class="text-right">15 mins ago</span></b></li>
							<li>There are 2 events near you next week <span class="text-right">2 days ago</span></li>
							<li>Jared has joined "Bird Watching Tour" in Central Park <span class="text-right">5 days ago</span></li>
						</ul>
					</fieldset>
					</form>
					</div>
				</div>
				
				<div class="tab-pane" id="settings">
					<div class="usertab-single-col">
						<form>
						  <fieldset>
						    <label class="muted">Receive alerts when...</label>
						    <label class="checkbox"><input type="checkbox">Co-learner joins event</label>
							<label class="checkbox"><input type="checkbox">Near an event you might be interested in</label>
							<label class="checkbox"><input type="checkbox">All events you might be interested in</label>
					
							<label class="muted">Set profile as...</label>
							<label class="radio"><input type="radio" name="profileaccess" value="public">Public</label>
							<label class="radio"><input type="radio" name="profileaccess" value="private">Private</label>
					
						    <button type="submit" class="btn btn-primary">Save</button>
						  </fieldset>
						</form>
				
					</div>
				</div>
				
			</div>
			<!-- END USER TAB-CONTENT -->
	  </div>
	</div>
    </div>
</div>
<!--<script src="js/map.js"></script>-->
{% endblock %}